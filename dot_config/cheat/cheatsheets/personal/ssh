---
tags: [ ssh ]
---
# port forwarding, self host by ssh
 https://ask.metafilter.com/224299/How-to-set-up-an-SSH-tunnel-on-an-addon-ip-address
- https://www.devdungeon.com/content/expose-local-port-over-remote-vps-ssh-remote-port-forwarding
- https://paullockaby.com/posts/2021/10/self-hosting-with-ssh-forwarding/
- https://scribe.rip/@mike.reider/using-sshuttle-as-a-service-bec2684a65fe
- https://arjan.wooning.cz/port-forward-behind-nat-or-cgnat/
- https://www.golinuxcloud.com/setup-ssh-port-forwarding/#13_Example-3_Setup_Local_Port_Forwarding_with_Gateway_Ports
- https://superuser.com/questions/900142/ssh-tunnel-through-second-ip-of-a-server
- https://hackertarget.com/ssh-two-factor-google-authenticator/https://blog.knoldus.com/port-forwarding-tunneling-in-linux/
########################################################################################################################
# sshdの設定
.ssh/authorized_keysにsshのpubkeyを記載するだけでなく､権限を適切に設定する必要があるようだ｡

ssh-copy-idでアクセスすることでディレクトリの作成とコピーを済ませられる｡キーはすべてコピーすることになるのか?

- https://web.archive.org/web/20140327182105/http://www.openssh.org/faq.html#3.14
ルートログイン無効化､パブリックキーのみ､ポート変更
- https://www.digitalocean.com/community/tutorials/how-to-use-ssh-to-connect-to-a-remote-server-ja
- https://www.howtogeek.com/devops/how-to-lock-down-your-ssh-server/


# ssh tunneling
https://www.devdungeon.com/content/expose-local-port-over-remote-vps-ssh-remote-port-forwarding
ssh -l root -R :9999:localhost:8000 <remote-server>
ssh -R 9999:localhost:8000 my-remote-host.com
オープンしてるか確認方法
	netstat -ntl  # Show listening ports, verify port 9999 is listening
	curl localhost:9999
グローバルにオープンするには
	GatewayPorts yesにする
.ssh/configにhostごとに､まとめて記載可能


# forwarding
ssh -L 80:localhost:80 name-of-remote-system
	ローカルの80にアクセスしたら､リモートの80にアクセスしたことにする｡

# sshをサービスとして設定
https://gist.github.com/drmalex07/c0f9304deea566842490
# autossh
# https://paullockaby.com/posts/2021/10/self-hosting-with-ssh-forwarding/


# forwarding config用のデータ作成
for i in `seq 5901 5920` ;do echo "LocalForward $i localhost:$i" ;done
for i in `seq 49153 49193` ;do echo "RemoteForward $i localhost:$i" ;done

# エラー
---
Warning: the ECDSA host key for 'myserver' differs from the key for the IP address '192.168.1.123'
---
- https://superuser.com/questions/421004/how-to-fix-warning-about-ecdsa-host-key
~/.ssh/known_hostsの該当する部分か全部を削除

# sshトライのブロツク
https://wiki.archlinux.jp/index.php/Sshguard
 	sshguardの試用(fail2banとかも)
ブロック中のものを表示:
	iptables --list sshguard --line-numbers --numeric
nvim /etc/sshguard/sshguard.conf 


# fail2ban
https://wiki.archlinux.jp/index.php/Fail2ban
port等の設定は､/etc/fail2ban/jail.confかjail.d/の内部

# 公開するものであれば､公開鍵等でフィンガープリントでき､shodanで公開されていたりする｡公開するものであれば､都度作成するほうがいい｡

# portを変えたとき
/etc/servicesで変更をすれば､fail2ban等でも自動で判別してくれるかも

########################################################################################################################
# To ssh via pem file (which normally needs 0600 permissions):
ssh -i <pemfile> <user>@<host>

# To connect on a non-standard port:
ssh -p <port> <user>@<host>

# To connect and forward the authentication agent:
ssh -A <user>@<host>

# To execute a command on a remote server:
ssh -t <user>@<host> 'the-remote-command'

# To connect to a host with a specific key exchange algorithm:
# Full list of available algorithms : man ssh_config
ssh -oKeXAlgorithms=+diffie-hellman-group-exchange-sha1 <user>@<server>

# To tunnel an x session over SSH:
ssh -X <user>@<host>

# Redirect traffic with a tunnel between local host (port 8080) and a remote
# host (remote.example.com:5000) through a proxy (personal.server.com):
ssh -f -L 8080:remote.example.com:5000 user@personal.server.com -N

# To launch a specific x application over SSH:
ssh -X -t <user>@<host> 'chromium-browser'

# To create a SOCKS proxy on localhost and <port>:
ssh -qND <port> <user>@<host>

# To tunnel an ssh session over the SOCKS proxy on localhost and port 9999:
ssh -o "ProxyCommand nc -x 127.0.0.1:9999 -X 4 %h %p" <user>@<host>

# -X use an xsession, -C compress data, "-c blowfish" use the encryption blowfish:
ssh <user>@<host> -C -c blowfish -X

# For more information, see:
# http://unix.stackexchange.com/q/12755/44856

# To copy files and folders through ssh from remote host to pwd with tar.gz
# compression when there is no rsync command available:
ssh <user>@<host> "cd /var/www/Shared/; tar zcf - asset1 asset2" | tar zxf -

# To mount folder/filesystem through SSH
# Install SSHFS from https://github.com/libfuse/sshfs
# Will allow you to mount a folder securely over a network.
sshfs <user>@<host>:/path/to/folder /path/to/mount/point

# Emacs can read file through SSH
# Doc: http://www.gnu.org/software/emacs/manual/html_node/emacs/Remote-Files.html
emacs /ssh:<user>@<host>:<file>
